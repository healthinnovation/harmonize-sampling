---
title: "Village sampling"
author: "Diego"
date: "`r Sys.Date()`"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(scales)
library(tidyr)
library(purrr)
library(cluster)
library(pheatmap)
library(factoextra)
library(sf)
library(FactoMineR)
library(yardstick)
```

```{r}
dataset <- read_csv("data/db_variables.csv", col_types = "ccd")
glimpse(dataset)
```
# Stratification

## Hierarchical clustering

```{r}
variables <- dataset %>% 
  select(etp:tmmn) %>% 
  mutate(across(everything(), rescale))
```

```{r}
dist_euclidean <- get_dist(variables, method = "euclidean")
dist_pearson <- get_dist(variables, method = "pearson")
dist_spearman <- get_dist(variables, method = "spearman")
```

### Heatmaps

```{r}
pheatmap(dist_euclidean)
```

```{r}
pheatmap(dist_pearson)
```

```{r}
pheatmap(dist_spearman)
```

### Selection of distance and linkage method

```{r}
dist_method <- c("euclidean", "pearson", "spearman")
linkage_method <- c("average", "single", "complete", "ward", "weighted")
```

```{r}
design <- expand_grid(dist_method, linkage_method, variables)
```

```{r}
agglomerative_coeff <- design %>% 
  nest(data = -c(dist_method, linkage_method)) %>% 
  mutate(
    dist_mat = map2(data, dist_method, ~get_dist(.x, method = .y)),
    tree = map2(dist_mat, linkage_method, ~agnes(.x, method = .y)),
    ac = map(tree, ~.x$ac)
  ) %>% 
  unnest(ac) %>% 
  arrange(-ac)
```

```{r}
agglomerative_coeff
```

```{r warning=FALSE}
fviz_dend(
  agglomerative_coeff$tree[[1]], main = "Pearson correlation - Ward linkage"
)
```

```{r warning=FALSE}
fviz_dend(
  agglomerative_coeff$tree[[2]], main = "Spearman correlation - Ward linkage"
)
```

### Selection of number of clusters

```{r}
fviz_nbclust(
  variables, hcut, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "pearson", 
  method = "silhouette"
)
```

```{r}
fviz_nbclust(
  variables, hcut, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "pearson", 
  method = "wss"
)
```

```{r}
fviz_nbclust(
  variables, hcut, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "pearson", 
  method = "gap_stat"
)
```

#### 3 clusters

```{r}
clustering_3 <- hcut(
  variables, k = 3, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "pearson"
)
```

```{r}
fviz_cluster(clustering_3, ggtheme = theme_classic()) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dashed")
```

```{r}
fviz_silhouette(clustering_3, ggtheme = theme_classic())
```

```{r}
variables %>% 
  mutate(group = as.factor(clustering_3$cluster)) %>% 
  group_by(group) %>% 
  summarise(across(everything(), mean), .groups = "drop") %>% 
  pivot_longer(-group) %>% 
  ggplot(aes(group, value, color = name, group = name)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(expand = c(0.05, 0.05)) +
  theme_classic()
```

#### 2 clusters

```{r}
clustering_2 <- hcut(
  variables, k = 2, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "pearson"
)
```

```{r}
fviz_cluster(clustering_2, ggtheme = theme_classic()) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dashed")
```

```{r}
fviz_silhouette(clustering_2, ggtheme = theme_classic())
```

```{r}
variables %>% 
  mutate(group = as.factor(clustering_2$cluster)) %>% 
  group_by(group) %>% 
  summarise(across(everything(), mean), .groups = "drop") %>% 
  pivot_longer(-group) %>% 
  ggplot(aes(group, value, color = name, group = name)) +
  geom_point() +
  geom_line() +
  scale_x_discrete(expand = c(0.05, 0.05)) +
  theme_classic()
```

#### 4 clusters

```{r}
clustering_4 <- hcut(
  variables, k = 4, hc_func = "agnes", hc_method = "ward.D2", hc_metric = "pearson"
)
```

```{r}
fviz_cluster(clustering_4, ggtheme = theme_classic()) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = 0, linetype = "dashed")
```

```{r}
fviz_silhouette(clustering_4, ggtheme = theme_classic())
```

```{r}
variables %>% 
  mutate(group = as.factor(clustering_4$cluster)) %>% 
  group_by(group) %>% 
  summarise(across(everything(), mean), .groups = "drop") %>% 
  pivot_longer(-group) %>% 
  ggplot(aes(group, value, color = name, group = name)) +
  geom_point() +
  scale_x_discrete(expand = c(0.05, 0.05)) +
  geom_line() +
  theme_classic()
```

### Maps

```{r}
dataset_clustering <- dataset %>% 
  mutate(
    hc_group_2 = as.factor(clustering_2$cluster),
    hc_group_3 = as.factor(clustering_3$cluster),
    hc_group_4 = as.factor(clustering_4$cluster)
  )
```

```{r}
dataset_clustering %>% 
  st_as_sf(coords = c("lon", "lat")) %>% 
  ggplot(aes(color = hc_group_2)) +
  geom_sf() +
  theme_classic()
```

```{r}
dataset_clustering %>% 
  st_as_sf(coords = c("lon", "lat")) %>% 
  ggplot(aes(color = hc_group_3)) +
  geom_sf() +
  theme_classic()
```

```{r}
dataset_clustering %>% 
  st_as_sf(coords = c("lon", "lat")) %>%  
  ggplot(aes(color = hc_group_4)) +
  geom_sf() +
  theme_classic()
```

# Principal components analysis

```{r}
pca <- PCA(variables, graph = FALSE)
```

## Scree plot

```{r}
fviz_screeplot(pca)
```

### Contribution plot

```{r}
fviz_contrib(pca, choice = "var", axes = 1, top = 10)
```

```{r}
fviz_contrib(pca, choice = "var", axes = 2, top = 10)
```

### Coordinate plane

```{r}
fviz_pca_ind(pca)
```

### Scoring

```{r}
pca_results <- get_pca_ind(pca)
scores <- pca_results$coord
```

```{r}
dataset_pca <- dataset_clustering %>% 
  mutate(pca_score = scores[, 1]) %>% 
  mutate(
    pca_group_2 = cut(
      pca_score, breaks = quantile(pca_score, c(0, .5, 1)), 
      labels = as.character(rev(1:2)),
      include.lowest = TRUE
    ),
    pca_group_3 = cut(
      pca_score, breaks = quantile(pca_score, c(0, .33, .66, 1)), 
      labels = as.character(rev(1:3)),
      include.lowest = TRUE
    ),
    pca_group_4 = cut(
      pca_score, breaks = quantile(pca_score, c(0, .25, .5, .75, 1)), 
      labels = as.character(rev(1:4)),
      include.lowest = TRUE
    )
  ) %>% 
  mutate(across(pca_group_2:pca_group_4, forcats::fct_rev))
```

### Maps

```{r}
dataset_pca %>% 
  st_as_sf(coords = c("lon", "lat")) %>%  
  ggplot(aes(color = pca_group_2)) +
  geom_sf() +
  theme_classic()
```

```{r}
dataset_pca %>% 
  st_as_sf(coords = c("lon", "lat")) %>%  
  ggplot(aes(color = pca_group_3)) +
  geom_sf() +
  theme_classic()
```

```{r}
dataset_pca %>% 
  st_as_sf(coords = c("lon", "lat")) %>%  
  ggplot(aes(color = pca_group_4)) +
  geom_sf() +
  theme_classic()
```

## Comparison

### 2 groups

```{r}
dataset_pca %>% 
  conf_mat(hc_group_2, pca_group_2, dnn = c("PCA", "HC"))
```

```{r}
dataset_pca %>% 
  kap(hc_group_2, pca_group_2)
```


### 3 groups

```{r}
dataset_pca %>% 
  conf_mat(hc_group_3, pca_group_3, dnn = c("PCA", "HC"))
```

```{r}
dataset_pca %>% 
  kap(hc_group_3, pca_group_3)
```


### 4 groups

```{r}
dataset_pca %>% 
  conf_mat(hc_group_4, pca_group_4, dnn = c("PCA", "HC"))
```

```{r}
dataset_pca %>% 
  kap(hc_group_4, pca_group_4)
```

# Sampling

```{r}
set.seed(2022)

sampling <- dataset_pca %>% 
  group_by(hc_group_2) %>% 
  slice_sample(prop = 0.36) %>% 
  ungroup()
```

```{r}
full_dataset <- dataset_pca %>% 
  st_as_sf(coords = c("lon", "lat"))

sample_dataset <- sampling %>% 
  st_as_sf(coords = c("lon", "lat"))
```

```{r}
ggplot(full_dataset) +
  geom_sf(alpha = 0.1) +
  geom_sf(aes(color = hc_group_2), data = sample_dataset) +
  theme_classic()
```

```{r}
# write_csv(samples, "data/village-clust-samples.csv")
```




